from blockchain.backend.util import util

from backend.entities.patient import Patient
from backend.entities.health_authority import HealthAuthority
from blockchain.backend.core.transaction import Transaction
from blockchain.backend.core.transaction_body import TransactionBody
from blockchain.backend.core.chain import Chain
from blockchain.backend.core.block import Block
from datetime import datetime


patient = Patient("Petar", "Djorjdevic")
hospital = HealthAuthority("Dom Zdravlja",'sadfasd',"asdfasd",'asdfasfd')

#dodaj nove kljuve iz baze

patient.public_key = "30820122300d06092a864886f70d01010105000382010f003082010a0282010100d570ae79242c9d26a3c7da6176c5fc50612f7ff6152d3af7af21c5e2fc2565ebcd3286c33ce144b7e24ba842a32dcd4a249247cf1acd621dcdce0b642766e663c2c1776a5b5fb1fa83df901a572c648190e8440d371ac4fdd77c4ac368262e432b113b0934baa97c6692277ab1b44f526387e51c72974e7de65201367cf5a8265230342b1a4aa497d0138fa1037d16491fc2fe99ede79a0a10dbb6f55a5471fcc571465a2b2b14fbe6b27d4e0a765b6f6755515e9516d00bd2d7fd3b9faf92a914360fa28cad6d901c5887cf1b2e0e19a47532930978855a863856f24919d0d115a965be3dddaf547afb0df40fff0f6808063a5edf96f5268e35128cef27f55f0203010001"
patient.private_key = "308204a40201000282010100d570ae79242c9d26a3c7da6176c5fc50612f7ff6152d3af7af21c5e2fc2565ebcd3286c33ce144b7e24ba842a32dcd4a249247cf1acd621dcdce0b642766e663c2c1776a5b5fb1fa83df901a572c648190e8440d371ac4fdd77c4ac368262e432b113b0934baa97c6692277ab1b44f526387e51c72974e7de65201367cf5a8265230342b1a4aa497d0138fa1037d16491fc2fe99ede79a0a10dbb6f55a5471fcc571465a2b2b14fbe6b27d4e0a765b6f6755515e9516d00bd2d7fd3b9faf92a914360fa28cad6d901c5887cf1b2e0e19a47532930978855a863856f24919d0d115a965be3dddaf547afb0df40fff0f6808063a5edf96f5268e35128cef27f55f0203010001028201002f613819c421f330a4a2b4a3760e351852ba8c993fd22e88d4e3965df0c30c80efa80baa43556e3fb3883fedaaf37be2bd838b553a09e581e031a0edb6a16cfb303c6a19bdf6dc375416c892504f966ffc8ed2ac6c5310ef986a0ade9dbbfc01050a6a247d0402a38ed15ada2da06d0b48f4ddb316ece78ba3190913e36154d5e4fb954b56ae9312cd1d2fbd1458811cc42c372fd126f7ba12eb2e075a43b7b380993eb5261b10febe943a0d880a75eaced7fe4a0d8698f9d7391e9265edc72017b239fd795b0029fe7fc97d3cc65eec55bc69c35f252378785293b12ba1a11679f66f8e2f8f67eeac93cf15b47ee45c8a96d25849f0acc7b143f9f6e3f4dfe102818100defa96c64874f096f20082bc201949babb47bab52ad3566f25f5ebdd53ac066047fb7a66357556dd80b4238d3213f8168f4fa63ef1c89dd2dc486d83e1433c240ff10afee8ed2bd68543f070ac35dc5c648dbe1e7f6d2f8c05156bbda064dac9f08c734a70dc74ed1010b5a46cf3afcf9ceeaaeccb25ee90886c77a2594028dd02818100f50c77e56b1b010dbec08a7f0928ffeab7f1ab26d99fe5d496c3255b4fbc9647aaeadd15df52a711f28166be7c513fd96dc201860e247b8f0b33e29292016688faa7f41a772fef6c9c0bef0dccbb98872e273c261c8316c8084c2a6b14a1df92877fbea2d5d87b8bde96ccfcba4308f547349d2fd70be6b1a621f0cf2bc3d56b028181009e3724e0d0ecd901e1f966ca61e44fa285dca1a88718aa0df7db855ee84df9c03b933f08630a3d76b22a1fc7c22ed52bfcc841680c5b9350d929333c0e8c8c91f215d0fd8afd2ecbea8788860a4bb56e8192e9c1ee1ce54def1581fb6d61e2b4c3508545decb2ed43f3ffc030da3e3ade6e69ab5a677e5ccfc602a8b31d50aa90281807f4568881926bf575a393a355c9694c45da100d97eb21376648f1a39e0a1fc1360ebf6c3c367742a581f693389f1d10da679dabcbb5fab64d1d6b2d899486ceebbf0bb517b91c3f24ee1cbd908fa6defd7c2bcf4b65e4758c1267de97b9fcf3495777d95a9277493629a440106e486248e44ff56b78410df377fed484c5cbbdd02818100dcfd3a1f4424f75cc57c91cc63591463f37630ab9d417ba904d4ed17e8751713ebf42105ed4145a4734a059e756f2ec59cc7c06789a0edf430a57b002c4b3ac60fb72aba5f0d2064902b9e3f9657ef8884351a179f5be9f70baeb60155d7f7c1dcc8c67b74293a831ba89b3fa753d4a293f28f8f5d4f56525555bd6a8d2fa71c"

hospital.public_key = "30820122300d06092a864886f70d01010105000382010f003082010a0282010100c3aec1b6981b1f81b703e7f39893350c06b602bb61f6e1250667648c633414f036cdbf2879e09cfb0edfd57b8b9c362b0e1556a0fb60379a27789d2a8df5ab3c016fb1e712ea9af2e25d1645c7b4296177294431864d74e889673245778de45145e772e78f662ea71558582a84f2f5c97ed10f00c1ce76f65e93f3e592eee42685d6b8739a2a1db3d78ae284a06c8992cfdcbb4fe6542717a9d3d439a41c822381e4081b0c37accc07c3b801d9d10cb810d1bd63aed7960f8b87867f9ab931844b93460180339b37a98cb002a707abc70e8461259ee796e191e89288b1ea53c22ee8e682baaba67dcbe69a718e7862b3e2b4104d7b08de469968511d81ff226b0203010001"
hospital.private_key = "308204a30201000282010100c3aec1b6981b1f81b703e7f39893350c06b602bb61f6e1250667648c633414f036cdbf2879e09cfb0edfd57b8b9c362b0e1556a0fb60379a27789d2a8df5ab3c016fb1e712ea9af2e25d1645c7b4296177294431864d74e889673245778de45145e772e78f662ea71558582a84f2f5c97ed10f00c1ce76f65e93f3e592eee42685d6b8739a2a1db3d78ae284a06c8992cfdcbb4fe6542717a9d3d439a41c822381e4081b0c37accc07c3b801d9d10cb810d1bd63aed7960f8b87867f9ab931844b93460180339b37a98cb002a707abc70e8461259ee796e191e89288b1ea53c22ee8e682baaba67dcbe69a718e7862b3e2b4104d7b08de469968511d81ff226b0203010001028201003f2c9e317aedd6c023fbc8d8a5fb7076cf7bd769f378a6bb335411ec18e2e9979bb9d4eb165de39051ff0586fb4d95575516a27f1a68b7cab6cf83be0752b6d38a8b2ade350734bb1145883942fdf1161c486051b4d030dc19f00d14cc422ce1e8358ead1f6897cb2d62f623d4043441b7057b587d3950c2bd49fac5b52816d3a06261a77d611949b1cd7b429157d49f55ec7a9733a195686b8d050564ff41964668d579d4249858b3189c7402638c33cf00cdc07a7f2da5dbbb7e4d4f8198e73e61813d6defb060d81c1f6be7074c7fa0ff51be95d8551d46e06033f58a0510bc701988faa747e10d5226e446406c4fde43d77348e749905a3db29bcc08b61102818100d6d5e4c3c44d9aeca58b72a9a8e57727009c68551db023129c61c57557cc0ff8082c72c74118cd22cba8d0724c83186845a3aafbc19d42e765cbb6e1c2fc324ca795c302045650308b16f381c0fc82e47c503d3e3de5a2343abd5a2a34e1f1f044a963da3f979f15eb837c1d5225b868aa2f9d9fd83150b3fd9e47f109258f7f02818100e92d6067a96cd32e7051e4d507e7cb99e0ad3cb241cb8518b6f0f9525235fd51af7f717b12a5ba67404cc27b0568afdc5fe61e963122515a834529d83045607c9784cff06afbf9347637b231c97970933aa400b212e1edd563c7d8b4f442ca7894299c582360da9c0f19c4e282e0e00f6b18b7cd048cd86c982ed68e46b4231502818100cd59484043bbf630eb0fbebb22e0ab22d1b7af1664b93edd0433845d645d7e8a13ae00cc2a91fd4a9c26b18fff4873a4ffa3b0c4d1cd72ece1e575da97d91e6f1ce4ceb077dad4ed81959f8e501c4d34ff0a676fbe146815ca6bc1ea83ffd0955bdc19c0bc763e2ee29e1c9d9e2ec5f4ed6f74181cbb0eabece94554c4ec6d1b0281806c278df5c712210a0333190eeeb1c730429457f8dea7c5be66ec72d88a255cb04cd4b21041dff90bf7392363e8685c59bd69817a6ca3dc543d5b1143a3702a86dfc8cca2591d32c3f0a978cfbb01c703a3497ac11e1d0931d72c5509e9da290bb0bd74353583b1227da69839f036d9f68cd854389609b640f87d912b410440d9028180401d82bafefbb1c92dbfba6f6ef2f5032c90d3954372c5aed8c4d75e9f047e160a87a21232d3480c2b3c4c3a4d1bb7e9380abc3d61e3f51f22beb15bc6c5728ad972079c2883ab48627f3d9c8b7e4a47d970c028c343d76c8648c390f2222b2a47c39d4b60e16f411014b6c6dcf6bbe828c34d2ec1382c919abdffe2456da9fd"

medical_record = {
    "id":"asdfadsf00",
    "patient_id": "987654321",
    "patient_name": "Petar Đorđević",
    "lab_test": {
      "date": "2025-08-01",
      "results": {
        "CRP": "12 mg/L",
        "Leukociti": "8.1 x10^9/L"
      }
    },
    "diagnosis": "Blaga bakterijska infekcija",
    "doctor_name": "Dr. Jovana Petrović",
    "doctor_id":"asdfasdf",
    "hospital_name": "Dom zdravlja Novi Beograd",
    "hospital_id":"asdfasdfasfasdf"
  }

transaction_body = TransactionBody(hospital.public_key,patient.public_key, 'https:://nseto',datetime.now().isoformat(),util.hash256(medical_record))
transaction = Transaction(transaction_body)
hospital.sign(transaction)


chain = Chain('asdfas',20,5)

if chain.add_transaction(transaction,medical_record) is True:
  new_block = chain.create_new_block()
  
  if Block.is_valid(new_block,chain) is True:
    chain.add_to_block_to_chain(new_block)
   

Chain.is_valid(chain)
print(chain)




